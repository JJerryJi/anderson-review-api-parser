<!DOCTYPE html>
<html>
<head>
  <title>Retrieve Articles with Research Links</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
  <script>
    // Your JavaScript code using jQuery here
    $(document).ready(function() {
      function getFeaturedMediaLink(mediaId) {
        const url = `https://anderson-review.ucla.edu/wp-json/wp/v2/media/${mediaId}`;
        return $.getJSON(url);
      }

      function getResearchLinkById(researchId) {
        const url = `https://anderson-review.ucla.edu/wp-json/wp/v2/ucla_faculty_bio/${researchId}`;
        return $.getJSON(url);
      }

      function retrieveArticlesWithResearchLinks() {
        const url = "https://anderson-review.ucla.edu/wp-json/wp/v2/posts";
        const params = {
          per_page: 4,
          _fields: "title,featured_media,link,acf"
        };

        return $.getJSON(url, params);
      }

      retrieveArticlesWithResearchLinks()
        .done(function(data) {
          const researchLinks = {};
          for (let i = 0; i < data.length; i++) {
            const link = data[i].link;
            const acf = data[i].acf;
            const title = data[i].title.rendered;
            const featuredMediaId = data[i].featured_media;

            const researchIds = acf.article_attribution_research_by || [];

            if (researchIds.length > 0) {
              const researcherLink = getResearchLinkById(researchIds[0]);

              researcherLink.done(function(researchData) {
                if (researchData) {
                  getFeaturedMediaLink(featuredMediaId)
                    .done(function(mediaData) {
                      researchLinks[i] = [{
                        title: title,
                        link: link,
                        featured_media_link: mediaData.source_url,
                        researcher: researchData.link
                      }];

                      // Check if all articles have been processed
                      if (Object.keys(researchLinks).length === data.length) {
                        console.log('Research Links:', researchLinks);
                      }
                    })
                    .fail(function(jqXHR, textStatus, errorThrown) {
                      console.error('Failed to retrieve featured media link:');
                      console.error('Status:', textStatus);
                      console.error('Error:', errorThrown);
                    });
                }
              })
              .fail(function(jqXHR, textStatus, errorThrown) {
                console.error('Failed to retrieve research link:');
                console.error('Status:', textStatus);
                console.error('Error:', errorThrown);
              });
            }
            else {
              researchLinks[i] = [{
                title: title,
                link: link,
                featured_media_link: '',
                researcher: "https://anderson-review.ucla.edu"
              }];
            }
          }
        })
        .fail(function(jqXHR, textStatus, errorThrown) {
          console.error('Failed to retrieve articles:');
          console.error('Status:', textStatus);
          console.error('Error:', errorThrown);
        });
    });
  </script>
</body>
</html>
